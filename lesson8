###### Lesson 8 #######

### 8-1 ###
https://docs.docker.com/compose/install/
sudo curl -L "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version

### 8-2 ###
cd
mkdir mycompose
cd mycompose
cp ../work2/Dockerfile .
cp ../work2/index.html .
vi docker-compose.yml

### docker-compose.yml ###
version: "3.8"
services:
  myweb:
    build: .
    ports:
      - "8080:80"
  apache:
    image: "httpd:latest"
    ports:
      - "80:80"
      
## ここで不要なコンテナを削除すると分かりやすいです ##
## 全コンテナ一括削除（稼働中も全て）するコマンド（例）##
docker rm -f $(docker ps -a -q)

docker-compose up -d
docker-compose ps

## ここで２つのWeb画面をチェックしましょう ##
http://ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:8080  ## ホスト名は自身のモノに変更
http://ec2-xx-xx-xx-xx.ap-northeast-1.compute.amazonaws.com:80　　## ホスト名は自身のモノに変更（80は省略可能）

docker-compose down
docker-compose ps


# WordPress
# 上記で作成したDockerfileはそのままに、dockercompose.ymlを以下のように書き直し
# docker-compose up -d　を実行
# docker-compose ps　で確認しましょう
# ブラウザ上では、http://ホスト名:8000　でアクセスしてみましょう

# WordPress用のdockercompose.ymlファイルです
version: '3.3'

services:
   db:
     image: mysql:5.7
     volumes:
       - db_data:/var/lib/mysql
     restart: always
     environment:
       MYSQL_ROOT_PASSWORD: somewordpress
       MYSQL_DATABASE: wordpress
       MYSQL_USER: wordpress
       MYSQL_PASSWORD: wordpress

   wordpress:
     depends_on:
       - db
     image: wordpress:latest
     ports:
       - "8000:80"
     restart: always
     environment:
       WORDPRESS_DB_HOST: db:3306
       WORDPRESS_DB_USER: wordpress
       WORDPRESS_DB_PASSWORD: wordpress
       WORDPRESS_DB_NAME: wordpress
volumes:
    db_data: {}
 
 
# 確認終了後　後処理
docker-compose down
docker-compose ps
